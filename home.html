<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Chat Example</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script type="text/javascript">
            function setCookie(cname, cvalue, exdays) {
                const d = new Date();
                d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                let expires = "expires="+d.toUTCString();
                document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
            }

            function getCookie(cname) {
                let name = cname + "=";
                let ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) == ' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length);
                    }
                }
                return "";
            }

            function eraseCookie(name) {
                document.cookie = name+'=; Max-Age=-99999999;';
            }

            function askName() {
                let username = getCookie("username");

                if (username === "") {
                    username = prompt("Enter Your Name Please :");
                }

                if (username != null) {
                    document.getElementById("username").innerHTML = "Hello, " + username + ". Say Something : ";
                    setCookie("username", username, 30)
                } else {
                    document.getElementById("noUser").innerHTML = "Welcome, Stranger!";
                }
            }

            let conn;

            window.onload = function () {

                askName()
                let msg = document.getElementById("msg");
                let log = document.getElementById("log");

                function appendLog(item) {
                    let doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                    log.appendChild(item);
                    if (doScroll) {
                        log.scrollTop = log.scrollHeight - log.clientHeight;
                    }
                }

                document.getElementById("form").onsubmit = function () {
                    let username = getCookie("username");
                    if (!conn) {
                        return false;
                    }
                    if (!msg.value) {
                        return false;
                    }
                    conn.send("<b>" + username + "</b> : " + msg.value);
                    msg.value = "";
                    return false;
                };

                if (window["WebSocket"]) {
                    conn = new WebSocket("ws://" + document.location.host + "/ws");
                    conn.onclose = function (evt) {
                        var item = document.createElement("div");
                        item.innerHTML = "<b>Connection closed.</b>";
                        appendLog(item);
                    };
                    conn.onmessage = function (evt) {
                        var messages = evt.data.split('\n');
                        for (var i = 0; i < messages.length; i++) {
                            var item = document.createElement("div");
                            item.innerHTML = messages[i];
                            appendLog(item);
                        }
                    };
                } else {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    appendLog(item);
                }

            };

            window.onunload = function () {
                if(!conn){
                    console.log("connection error")
                }
                let username = getCookie("username");
                conn.send("User <b>" + username + "</b> : disconnected")
                eraseCookie("username")
            }


        </script>
        <style type="text/css">
            html, body {
                height: 100%;
            }

            #wrap {
                min-height: 100%;
            }

            #main {
                overflow:auto;
                padding-bottom:150px; /* this needs to be bigger than footer height*/
            }

            .footer {
                position: relative;
                margin-top: -150px; /* negative value of footer height */
                height: 150px;
                clear:both;
                padding-top:20px;
            }

        </style>
    </head>
    <body>
        <div id="wrap">
            <div id="main" class="container clear-top">
                <br />
                <div id="log"></div>
            </div>
        </div>

        <div class="footer container">
            <form id="form">
                <h3 id="username"></h3>
                <div class="input-group">
                    <input type="text" id="msg" class="form-control" autocomplete="off" placeholder="Enter Message ..." aria-label="Enter Message ..." aria-describedby="button-addon2" autofocus>
                    <button class="btn btn-success" type="submit" id="button-addon2"><i class="fa fa-paper-plane"> Send</i></button>
                </div>
            </form>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    </body>
</html>